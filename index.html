<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RHYTHM">
<meta name="theme-color" content="#080c10">
<title>RHYTHM TRADING</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap');
:root {
  --bg:#080c10; --surface:#0d1117; --surface2:#111820; --surface3:#161f2a;
  --border:#1e2d3d; --border2:#2a3d52;
  --green:#00e5a0; --red:#ff4060; --yellow:#f5c842;
  --blue:#4ab0ff; --purple:#b080ff; --orange:#ff8c42;
  --text:#c8d8e8; --text-dim:#6080a0; --text-bright:#e8f4ff;
  --mono:'Share Tech Mono',monospace; --display:'Barlow Condensed',sans-serif; --body:'Barlow',sans-serif;
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--body);display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom);}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:9999;}

/* HEADER */
.hdr{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:11px 16px 9px;background:var(--surface);border-bottom:1px solid var(--border);z-index:200;}
.logo{font-family:var(--display);font-weight:900;font-size:20px;letter-spacing:5px;color:var(--green);text-shadow:0 0 16px rgba(0,229,160,0.35);line-height:1;}
.logo-sub{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-top:1px;}
.hdr-r{display:flex;align-items:center;gap:10px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.35}}
.rfr-btn{font-family:var(--mono);font-size:9px;letter-spacing:1px;color:var(--text-dim);background:var(--surface2);border:1px solid var(--border);padding:5px 10px;border-radius:3px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.rfr-btn:active,.rfr-btn:hover{color:var(--green);border-color:var(--green);}
.rfr-btn.spin{animation:spinner 1s linear infinite;}
@keyframes spinner{to{transform:rotate(360deg);}}

/* STATUS */
.status-bar{flex-shrink:0;font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:1px;padding:5px 16px;text-align:center;border-bottom:1px solid var(--border);background:var(--surface2);}

/* TICKER STRIP */
.strip{flex-shrink:0;display:flex;overflow-x:auto;background:var(--surface2);border-bottom:1px solid var(--border);scrollbar-width:none;}
.strip::-webkit-scrollbar{display:none;}
.strip-item{flex-shrink:0;padding:6px 14px;border-right:1px solid var(--border);cursor:pointer;transition:background .15s;display:flex;flex-direction:column;align-items:center;gap:1px;}
.strip-item:hover{background:var(--surface3);}
.s-sym{font-family:var(--display);font-weight:700;font-size:13px;letter-spacing:2px;}
.s-pct{font-family:var(--mono);font-size:9px;}
.strip-add{flex-shrink:0;padding:6px 16px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-dim);font-size:20px;transition:color .15s;}
.strip-add:hover{color:var(--green);}

/* TABS */
.tabs{flex-shrink:0;display:flex;background:var(--surface);border-bottom:1px solid var(--border);}
.tab{flex:1;font-family:var(--display);font-weight:700;font-size:10px;letter-spacing:1px;padding:8px 2px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;text-transform:uppercase;text-align:center;}
.tab.active{color:var(--green);border-bottom-color:var(--green);}

/* SCROLL AREA */
.main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.tc{display:none;padding:12px;}
.tc.active{display:block;}

/* CHANNEL CARDS */
.cgrid{display:grid;grid-template-columns:1fr;gap:12px;}
@media(min-width:600px){.cgrid{grid-template-columns:repeat(2,1fr);}}
@media(min-width:1000px){.cgrid{grid-template-columns:repeat(3,1fr);}}
.scard{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;position:relative;}
.scard-hdr{padding:11px 14px 10px;display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid var(--border);}
.tk{font-family:var(--display);font-weight:900;font-size:30px;letter-spacing:2px;line-height:1;}
.tk.energy{color:var(--yellow);}.tk.infra{color:var(--blue);}.tk.optical{color:var(--purple);}.tk.memory{color:var(--green);}.tk.default{color:var(--orange);}
.co{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:3px;}
.price-col{text-align:right;}
.cp{font-family:var(--display);font-weight:700;font-size:26px;letter-spacing:1px;color:var(--text-bright);line-height:1;}
.dc{font-family:var(--mono);font-size:11px;margin-top:3px;}
.up{color:var(--green);}.dn{color:var(--red);}.fl{color:var(--text-dim);}
.ohlc{display:grid;grid-template-columns:repeat(4,1fr);background:var(--surface2);border-bottom:1px solid var(--border);}
.oc{padding:6px 8px;border-right:1px solid var(--border);}
.oc:last-child{border-right:none;}
.ol{font-family:var(--mono);font-size:7px;letter-spacing:1px;color:var(--text-dim);}
.ov{font-family:var(--mono);font-size:11px;margin-top:2px;}
.ch-sec{padding:11px 14px 6px;}
.ch-lbl{font-family:var(--mono);font-size:8px;letter-spacing:1px;color:var(--text-dim);margin-bottom:6px;}
.ch-bar{position:relative;height:34px;background:var(--surface2);border-radius:3px;overflow:hidden;border:1px solid var(--border);}
.cz{position:absolute;top:0;bottom:0;}
.z-d{background:rgba(255,64,96,0.2);}.z-l{background:rgba(255,64,96,0.07);}.z-m{background:rgba(255,255,255,0.02);}.z-h{background:rgba(0,229,160,0.07);}.z-e{background:rgba(176,128,255,0.18);}
.zdv{position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.07);}
.cur{position:absolute;top:0;bottom:0;width:4px;border-radius:2px;z-index:5;transition:left .4s ease;}
.cur-lbl{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:8px;white-space:nowrap;font-weight:700;}
.rng-lo{position:absolute;top:50%;transform:translateY(-50%);left:4px;font-family:var(--mono);font-size:7px;color:rgba(255,100,100,0.5);}
.rng-hi{position:absolute;top:50%;transform:translateY(-50%);right:4px;font-family:var(--mono);font-size:7px;color:rgba(0,200,120,0.5);}
.ch-marks{display:flex;justify-content:space-between;margin-top:22px;font-family:var(--mono);font-size:8px;color:var(--text-dim);}
.candle-wrap{padding:10px 14px 32px;border-top:1px solid var(--border);}
.candle-lbl{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--text-dim);margin-bottom:7px;}
.candle-row{display:flex;gap:4px;height:56px;align-items:flex-end;}
.c-day{flex:1;height:100%;position:relative;}
.c-wick{position:absolute;left:50%;transform:translateX(-50%);width:1px;background:rgba(255,255,255,0.22);}
.c-body{position:absolute;left:8%;right:8%;min-height:2px;border-radius:1px;}
.c-date{position:absolute;bottom:-13px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:7px;color:var(--text-dim);white-space:nowrap;}
.c-pct{position:absolute;bottom:-25px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:8px;font-weight:700;white-space:nowrap;}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border);}
.sc{background:var(--surface);padding:8px 12px;}
.sl{font-family:var(--mono);font-size:7px;letter-spacing:2px;color:var(--text-dim);}
.sv{font-family:var(--display);font-size:16px;font-weight:700;margin-top:2px;}
.sig-row{padding:9px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.sig-b{font-family:var(--display);font-weight:700;font-size:11px;letter-spacing:2px;padding:4px 10px;border-radius:2px;white-space:nowrap;flex-shrink:0;}
.sn{background:rgba(0,229,160,0.1);color:var(--green);border:1px solid rgba(0,229,160,0.25);}
.sc2{background:rgba(245,200,66,0.12);color:var(--yellow);border:1px solid rgba(245,200,66,0.3);}
.sw{background:rgba(255,64,96,0.12);color:var(--red);border:1px solid rgba(255,64,96,0.3);}
.se{background:rgba(176,128,255,0.12);color:var(--purple);border:1px solid rgba(176,128,255,0.3);}
.sig-note{font-family:var(--mono);font-size:10px;color:var(--text-dim);line-height:1.5;text-align:right;}
.rm-btn{position:absolute;top:7px;right:8px;font-family:var(--mono);font-size:9px;color:var(--text-dim);background:none;border:none;cursor:pointer;opacity:0;transition:opacity .2s;padding:3px;}
.scard:hover .rm-btn{opacity:1;}
.rm-btn:hover{color:var(--red);}

/* FUNDAMENTALS TAB */
.f-wrap{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:12px;}
.f-hdr{padding:12px 14px;border-bottom:1px solid var(--border);}
.f-title{font-family:var(--display);font-weight:700;font-size:15px;letter-spacing:3px;color:var(--text-bright);}
.f-sub{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:3px;}
.ftable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:11px;min-width:700px;}
.ftable th{padding:9px 12px;font-size:8px;letter-spacing:2px;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border);font-weight:400;text-align:left;white-space:nowrap;}
.ftable td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.ftable tr:last-child td{border-bottom:none;}
.ftable tr:hover td{background:rgba(255,255,255,0.02);}
.f-sym{font-family:var(--display);font-weight:700;font-size:16px;letter-spacing:2px;}
.vscore{font-family:var(--display);font-weight:700;font-size:18px;letter-spacing:1px;}
.vs-hi{color:var(--green);}.vs-md{color:var(--yellow);}.vs-lo{color:var(--red);}
.earn-soon{color:var(--red);font-weight:700;}
.earn-near{color:var(--yellow);}
.earn-ok{color:var(--text-dim);}
.upside-pos{color:var(--green);}.upside-neg{color:var(--red);}
.beat{color:var(--green);font-size:12px;}.miss{color:var(--red);font-size:12px;}

/* VALUE SCORE EXPLAINER */
.fex-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
@media(max-width:600px){.fex-grid{grid-template-columns:1fr;}}
.fex-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px;}
.fex-title{font-family:var(--display);font-weight:700;font-size:13px;letter-spacing:3px;color:var(--text-bright);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.fex-row{display:flex;gap:12px;margin-bottom:8px;align-items:flex-start;}
.fex-key{font-family:var(--mono);font-size:10px;color:var(--green);flex-shrink:0;min-width:60px;font-weight:700;}
.fex-desc{font-family:var(--mono);font-size:10px;color:var(--text);line-height:1.6;}

/* WEEKLY */
.wcard{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:12px;}
.wcard-hdr{padding:11px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.wcard-title{font-family:var(--display);font-weight:700;font-size:14px;letter-spacing:3px;color:var(--text-bright);}
.log-btn{font-family:var(--mono);font-size:9px;letter-spacing:1px;color:var(--green);background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.25);padding:5px 10px;border-radius:3px;cursor:pointer;}
.wt{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:10px;}
.wt th{padding:7px 10px;font-size:7px;letter-spacing:2px;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border);font-weight:400;text-align:left;}
.wt td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle;}
.wt tr:last-child td{border-bottom:none;}
.wt-tk{font-family:var(--display);font-weight:700;font-size:13px;letter-spacing:2px;}
.mbar{display:inline-block;height:8px;border-radius:1px;vertical-align:middle;margin-right:4px;}
.cst{font-size:8px;letter-spacing:1px;padding:2px 6px;border-radius:2px;font-weight:700;}
.cs-n{background:rgba(0,229,160,0.1);color:var(--green);}
.cs-c{background:rgba(245,200,66,0.12);color:var(--yellow);}
.cs-e{background:rgba(176,128,255,0.12);color:var(--purple);}
.ni{font-family:var(--mono);font-size:10px;background:transparent;border:none;color:var(--text-dim);width:100%;outline:none;}
.ni:focus{color:var(--text);}
.pi{font-family:var(--mono);font-size:10px;background:transparent;border:none;color:var(--text);width:60px;outline:none;border-bottom:1px solid var(--border);}
.pi:focus{border-bottom-color:var(--green);}

/* ALERTS */
.acard{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px;}
.acard-title{font-family:var(--display);font-weight:700;font-size:13px;letter-spacing:3px;color:var(--text-bright);margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.a-step{display:flex;gap:12px;margin-bottom:12px;align-items:flex-start;}
.a-num{font-family:var(--display);font-weight:900;font-size:20px;color:var(--green);flex-shrink:0;line-height:1.1;}
.a-text{font-family:var(--mono);font-size:10px;color:var(--text);line-height:1.7;}
.a-text strong{color:var(--text-bright);}
.ntfy-row{display:flex;gap:8px;margin-top:8px;}
.ntfy-inp{flex:1;font-family:var(--mono);font-size:11px;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:8px 12px;border-radius:4px;outline:none;}
.ntfy-inp:focus{border-color:var(--green);}
.ntfy-save{font-family:var(--mono);font-size:10px;letter-spacing:1px;background:rgba(0,229,160,0.1);color:var(--green);border:1px solid rgba(0,229,160,0.25);padding:8px 12px;border-radius:4px;cursor:pointer;}
.a-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px;}
.a-label{font-family:var(--mono);font-size:10px;color:var(--text);flex:1;line-height:1.5;}
.a-inp{font-family:var(--mono);font-size:12px;width:65px;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:5px 8px;border-radius:3px;outline:none;text-align:center;}
.a-inp:focus{border-color:var(--yellow);}
.a-unit{font-family:var(--mono);font-size:10px;color:var(--text-dim);}
.big-btn{width:100%;font-family:var(--mono);font-size:10px;letter-spacing:2px;background:rgba(0,229,160,0.1);color:var(--green);border:1px solid rgba(0,229,160,0.25);padding:10px;border-radius:4px;cursor:pointer;margin-top:8px;}

/* DEPLOY */
.dcard{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px;}
.dcard-title{font-family:var(--display);font-weight:700;font-size:13px;letter-spacing:3px;color:var(--text-bright);margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.ds{display:flex;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.ds:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.ds-n{width:26px;height:26px;border-radius:50%;background:rgba(0,229,160,0.15);border:1px solid rgba(0,229,160,0.3);color:var(--green);font-family:var(--display);font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.ds-c{font-family:var(--mono);font-size:10px;color:var(--text);line-height:1.7;}
.ds-c strong{color:var(--text-bright);display:block;font-size:11px;margin-bottom:2px;letter-spacing:1px;}
.ds-c a{color:var(--blue);}
.code-block{background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:7px 10px;margin-top:5px;font-family:var(--mono);font-size:9px;color:var(--yellow);letter-spacing:1px;overflow-x:auto;white-space:nowrap;}

/* MODAL */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:500;align-items:center;justify-content:center;}
.modal-ov.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:8px;padding:22px;width:320px;max-width:92vw;}
.m-title{font-family:var(--display);font-weight:700;font-size:18px;letter-spacing:4px;color:var(--text-bright);margin-bottom:5px;}
.m-sub{font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:18px;letter-spacing:1px;line-height:1.6;}
.m-row{display:flex;gap:8px;margin-bottom:14px;}
.t-input{flex:1;font-family:var(--mono);font-size:16px;letter-spacing:3px;background:var(--surface2);border:1px solid var(--border2);color:var(--text-bright);padding:10px 14px;border-radius:4px;outline:none;text-transform:uppercase;}
.t-input:focus{border-color:var(--green);}
.add-btn{font-family:var(--display);font-weight:700;font-size:14px;letter-spacing:2px;background:rgba(0,229,160,0.15);color:var(--green);border:1px solid rgba(0,229,160,0.3);padding:10px 16px;border-radius:4px;cursor:pointer;white-space:nowrap;}
.m-status{font-family:var(--mono);font-size:10px;min-height:16px;margin-bottom:10px;}
.sug-lbl{font-family:var(--mono);font-size:8px;letter-spacing:3px;color:var(--text-dim);margin-bottom:8px;}
.sug-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;}
.chip{font-family:var(--mono);font-size:11px;padding:4px 10px;background:var(--surface2);border:1px solid var(--border2);border-radius:3px;cursor:pointer;color:var(--text);transition:all .15s;letter-spacing:1px;}
.chip:hover{border-color:var(--green);color:var(--green);}
.m-close{width:100%;font-family:var(--mono);font-size:10px;letter-spacing:3px;background:none;border:1px solid var(--border);color:var(--text-dim);padding:8px;border-radius:4px;cursor:pointer;margin-top:2px;}

/* LOADING */
.loading-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:24px;text-align:center;}
.loading-text{font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:2px;}
.loading-bar{height:2px;background:var(--border);border-radius:1px;margin-top:12px;overflow:hidden;}
.loading-fill{height:100%;background:var(--green);border-radius:1px;animation:lda 1.5s ease infinite;}
@keyframes lda{0%{width:0%;margin-left:0%}50%{width:60%;margin-left:20%}100%{width:0%;margin-left:100%}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div>
    <div class="logo">RHYTHM</div>
    <div class="logo-sub" id="statusSub">CHANNEL INTELLIGENCE Â· FMP CONNECTED</div>
  </div>
  <div class="hdr-r">
    <div class="live-dot"></div>
    <button class="rfr-btn" id="rfrBtn" onclick="refreshAll()">â†» REFRESH</button>
  </div>
</div>

<div class="status-bar" id="statusBar">TAP â†» REFRESH TO LOAD LIVE DATA Â· FMP KEY ACTIVE</div>

<!-- TICKER STRIP -->
<div class="strip" id="strip"></div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('channels',this)">CHANNELS</button>
  <button class="tab" onclick="switchTab('fundamentals',this)">FUNDMNTLS</button>
  <button class="tab" onclick="switchTab('weekly',this)">WEEKLY</button>
  <button class="tab" onclick="switchTab('alerts',this)">ALERTS</button>
  <button class="tab" onclick="switchTab('deploy',this)">ðŸ“± SETUP</button>
</div>

<!-- MAIN SCROLL AREA -->
<div class="main">

  <!-- CHANNELS -->
  <div id="tab-channels" class="tc active">
    <div class="cgrid" id="cardsGrid">
      <div class="loading-card">
        <div class="loading-text">TAP REFRESH TO LOAD LIVE DATA</div>
        <div class="loading-bar"><div class="loading-fill"></div></div>
      </div>
    </div>
  </div>

  <!-- FUNDAMENTALS -->
  <div id="tab-fundamentals" class="tc">
    <div class="f-wrap">
      <div class="f-hdr">
        <div class="f-title">FUNDAMENTALS SNAPSHOT</div>
        <div class="f-sub" id="fundsDate">LIVE DATA Â· FMP + SEC FILINGS Â· REFRESHES WITH EVERY UPDATE</div>
      </div>
      <div style="overflow-x:auto">
        <table class="ftable">
          <thead>
            <tr>
              <th>TICKER</th>
              <th>PRICE</th>
              <th>FWD P/E</th>
              <th>PEG RATIO</th>
              <th>REV GROWTH</th>
              <th>EPS TREND (3Q)</th>
              <th>ANALYST TARGET</th>
              <th>UPSIDE %</th>
              <th>EARNINGS IN</th>
              <th>VALUE SCORE</th>
            </tr>
          </thead>
          <tbody id="fundsBody">
            <tr><td colspan="10" style="text-align:center;padding:28px;font-family:var(--mono);font-size:10px;color:var(--text-dim);">TAP â†» REFRESH TO LOAD FUNDAMENTALS</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="fex-grid">
      <div class="fex-card">
        <div class="fex-title">VALUE SCORE GUIDE</div>
        <div class="fex-row"><div class="fex-key" style="color:var(--green)">8â€“10</div><div class="fex-desc">Growth fully justifies price. Fundamentals strong. Thesis intact.</div></div>
        <div class="fex-row"><div class="fex-key" style="color:var(--blue)">6â€“7</div><div class="fex-desc">Reasonable. Slightly stretched but earnings momentum intact.</div></div>
        <div class="fex-row"><div class="fex-key" style="color:var(--yellow)">4â€“5</div><div class="fex-desc">Caution. Price ahead of fundamentals. Watch closely.</div></div>
        <div class="fex-row"><div class="fex-key" style="color:var(--red)">1â€“3</div><div class="fex-desc">Priced for perfection. Any miss = big drawdown. Tighten stops.</div></div>
      </div>
      <div class="fex-card">
        <div class="fex-title">METRIC GLOSSARY</div>
        <div class="fex-row"><div class="fex-key">FWD P/E</div><div class="fex-desc">Price Ã· next 12mo earnings estimate. Recalculates live with every price change.</div></div>
        <div class="fex-row"><div class="fex-key">PEG</div><div class="fex-desc">P/E Ã· growth rate. Under 1.0 = cheap vs growth. Over 3.0 = expensive story.</div></div>
        <div class="fex-row"><div class="fex-key">REV GROWTH</div><div class="fex-desc">Year-over-year revenue growth. Updates within 24hrs of each earnings report.</div></div>
        <div class="fex-row"><div class="fex-key">EPS TREND</div><div class="fex-desc">Last 3 quarters: ðŸŸ¢ beat estimate or ðŸ”´ missed. Leading indicator of thesis health.</div></div>
        <div class="fex-row"><div class="fex-key">UPSIDE</div><div class="fex-desc">Current price vs consensus analyst target. Negative = stock ran past targets.</div></div>
      </div>
    </div>
  </div>

  <!-- WEEKLY -->
  <div id="tab-weekly" class="tc">
    <div class="wcard">
      <div class="wcard-hdr">
        <div class="wcard-title">WEEKLY LOG</div>
        <button class="log-btn" onclick="addWeekRow()">+ LOG WEEK</button>
      </div>
      <div style="overflow-x:auto">
        <table class="wt">
          <thead><tr>
            <th>SYM</th><th>WEEK</th><th>CLOSE</th>
            <th>CHG%</th><th>ZONE</th><th>STATUS</th><th>NOTES</th>
          </tr></thead>
          <tbody id="weeklyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ALERTS -->
  <div id="tab-alerts" class="tc">
    <div class="acard">
      <div class="acard-title">ðŸ“± PUSH ALERTS â€” NTFY SETUP</div>
      <div class="a-step"><div class="a-num">1</div><div class="a-text">Download <strong>ntfy</strong> on iPhone (free, App Store).</div></div>
      <div class="a-step"><div class="a-num">2</div><div class="a-text">Create a private channel name â€” e.g. <strong>walt-rhythm-2026</strong></div></div>
      <div class="a-step"><div class="a-num">3</div><div class="a-text">In ntfy app: Subscribe â†’ enter your channel name â†’ then paste below.</div></div>
      <div class="a-step"><div class="a-num">4</div><div class="a-text">RHYTHM pushes alerts on big moves, zone crosses, and earnings countdowns.</div></div>
      <div class="ntfy-row">
        <input class="ntfy-inp" id="ntfyCh" placeholder="your-channel-name">
        <button class="ntfy-save" onclick="saveNtfy()">SAVE</button>
      </div>
      <div style="font-family:var(--mono);font-size:9px;color:var(--text-dim);margin-top:6px" id="ntfyStatus"></div>
    </div>
    <div class="acard">
      <div class="acard-title">âš¡ ALERT THRESHOLDS</div>
      <div class="a-row"><div class="a-label">Alert when daily move exceeds:</div><input class="a-inp" id="alertPct" value="5" type="number" min="1" max="20"><span class="a-unit">%</span></div>
      <div class="a-row"><div class="a-label">Alert when entering DANGER zone:</div><input class="a-inp" id="alertDanger" value="15" type="number" min="5" max="30"><span class="a-unit">% of range</span></div>
      <div class="a-row"><div class="a-label">Alert when hitting EXTENDED zone:</div><input class="a-inp" id="alertExtended" value="85" type="number" min="60" max="99"><span class="a-unit">% of range</span></div>
      <div class="a-row"><div class="a-label">Alert when earnings within:</div><input class="a-inp" id="alertEarnings" value="7" type="number" min="1" max="30"><span class="a-unit">days</span></div>
      <button class="big-btn" onclick="testAlert()">ðŸ“¨ SEND TEST ALERT TO PHONE</button>
    </div>
  </div>

  <!-- DEPLOY / SETUP -->
  <div id="tab-deploy" class="tc">
    <div class="dcard">
      <div class="dcard-title">ðŸ”‘ FMP API KEY â€” ALREADY CONFIGURED</div>
      <div class="ds"><div class="ds-n">âœ“</div><div class="ds-c"><strong>KEY IS HARDCODED IN THIS APP</strong>Your FMP API key is embedded directly in the app code. No setup needed â€” fundamental data loads automatically every time you hit Refresh. If you regenerate your key at financialmodelingprep.com, just paste the new one in the JS section (search for FMP_KEY).</div></div>
      <div class="ds"><div class="ds-n">âš </div><div class="ds-c"><strong>REGENERATE YOUR KEY</strong>Since this key was shared in chat, go to <a href="https://financialmodelingprep.com">financialmodelingprep.com</a> â†’ Dashboard â†’ regenerate a new API key â†’ replace FMP_KEY in the code below with the new one before hosting publicly.</div></div>
    </div>
    <div class="dcard">
      <div class="dcard-title">ðŸ“± ADD TO IPHONE HOME SCREEN</div>
      <div class="ds"><div class="ds-n">1</div><div class="ds-c"><strong>HOST ON GITHUB PAGES (FREE)</strong>Go to <a href="https://github.com">github.com</a> â†’ New Repository â†’ "rhythm-trading" â†’ Public â†’ Create.</div></div>
      <div class="ds"><div class="ds-n">2</div><div class="ds-c"><strong>UPLOAD THIS FILE AS index.html</strong>Click "uploading an existing file" â†’ drag this file â†’ rename to index.html â†’ Commit.</div></div>
      <div class="ds"><div class="ds-n">3</div><div class="ds-c"><strong>ENABLE GITHUB PAGES</strong>Settings â†’ Pages â†’ Source: main branch â†’ Save.<div class="code-block">https://[username].github.io/rhythm-trading</div></div></div>
      <div class="ds"><div class="ds-n">4</div><div class="ds-c"><strong>ADD TO HOME SCREEN</strong>Open URL in iPhone Safari â†’ Share (box+arrow) â†’ "Add to Home Screen" â†’ RHYTHM â†’ Add. Full screen, no browser bars. Done.</div></div>
    </div>
    <div class="dcard">
      <div class="dcard-title">âœ… WHAT AUTO-UPDATES ON EVERY REFRESH</div>
      <div class="ds"><div class="ds-n">âœ“</div><div class="ds-c"><strong>LIVE (every tap of Refresh)</strong>Price, OHLC, % change, channel position, Forward P/E recalculated, analyst target gap, earnings countdown.</div></div>
      <div class="ds"><div class="ds-n">âœ“</div><div class="ds-c"><strong>POST-EARNINGS (within 24hrs of report)</strong>Revenue growth, EPS beat/miss history, PEG ratio, quarterly financials â€” all from FMP/SEC filings. Zero manual work.</div></div>
      <div class="ds"><div class="ds-n">âœ“</div><div class="ds-c"><strong>VALUE SCORE</strong>Recalculates automatically combining live price data with the latest quarterly fundamentals. One number tells you if price is justified.</div></div>
    </div>
  </div>

</div>

<!-- ADD TICKER MODAL -->
<div class="modal-ov" id="modalOv" onclick="closeBg(event)">
  <div class="modal">
    <div class="m-title">ADD TICKER</div>
    <div class="m-sub">Any US stock symbol. Live data loads from Yahoo + FMP.</div>
    <div class="m-status" id="mStatus"></div>
    <div class="m-row">
      <input class="t-input" id="tInput" placeholder="NVDA" maxlength="8" onkeydown="if(event.key==='Enter')addTicker()">
      <button class="add-btn" onclick="addTicker()">ADD</button>
    </div>
    <div class="sug-lbl">QUICK ADD</div>
    <div class="sug-chips" id="sugChips"></div>
    <button class="m-close" onclick="closeModal()">CANCEL</button>
  </div>
</div>

<script>
// ============================================================
// API KEYS â€” replace FMP_KEY if you regenerate at fmp
// ============================================================
const FMP_KEY = 'Rumf7w78vVsVZQKoxlGRq4PRMyl6YcwS';
const TD_KEY  = 'a831b3ea9a7446cc87e79eeff04723d5';
const TD_BASE = 'https://api.twelvedata.com';
const FMP = 'https://financialmodelingprep.com/api/v3';
// FMP supports CORS directly â€” no proxy needed
async function pFetch(url, ms=10000) {
  try { const r = await fetch(url,{signal:AbortSignal.timeout(ms)}); if(r.ok) return r; } catch {}
  return null;
}

// ============================================================
// CORE STATE
// ============================================================
const DEFAULT_TICKERS = ['VRT','MU','LITE','BE','SNDK'];
const SUGGESTIONS = ['NVDA','AMD','AAPL','CEG','VST','COHR','ARM','TSM','AVGO','MSFT'];

const SECTOR_MAP = {
  VRT:'infra', MU:'memory', LITE:'optical', BE:'energy', SNDK:'memory',
  NVDA:'memory', AMD:'memory', INTC:'memory', QCOM:'memory', TSM:'memory', AVGO:'memory', ARM:'memory',
  AAPL:'infra', MSFT:'infra', GOOGL:'infra', META:'infra', AMZN:'infra',
  CEG:'energy', VST:'energy', NRG:'energy', NEE:'energy',
  COHR:'optical', IIVI:'optical',
};
const TC = {energy:'#f5c842',infra:'#4ab0ff',optical:'#b080ff',memory:'#00e5a0',default:'#ff8c42'};

// Historical channel seed data (Feb 25 2026 â€” Grok/Yahoo)
const SEED = {
  VRT: {wk52Low:50, ath:255.54, normalPullback:'15â€“28%', breakLevel:'~$210', runPct:'+416%',
    candles:[{date:'F18',o:247.00,h:254.05,l:240.38,c:243.21},{date:'F19',o:241.03,h:247.71,l:239.52,c:243.06},{date:'F20',o:240.99,h:246.80,l:238.19,c:243.75},{date:'F23',o:242.60,h:245.77,l:240.00,c:245.42},{date:'F24',o:246.50,h:253.48,l:241.27,c:253.15}]},
  MU: {wk52Low:85, ath:455.50, normalPullback:'20â€“38%', breakLevel:'~$340', runPct:'+435%',
    candles:[{date:'F18',o:399.50,h:427.85,l:394.60,c:420.95},{date:'F19',o:415.81,h:420.32,l:407.74,c:417.35},{date:'F20',o:415.18,h:430.57,l:415.15,c:428.17},{date:'F23',o:422.31,h:431.70,l:415.30,c:420.97},{date:'F24',o:429.22,h:436.27,l:411.28,c:418.01}]},
  LITE:{wk52Low:45, ath:765.00, normalPullback:'22â€“45%', breakLevel:'~$520', runPct:'+1,600%',
    candles:[{date:'F18',o:602.09,h:610.30,l:587.00,c:594.26},{date:'F19',o:592.57,h:636.68,l:578.30,c:635.64},{date:'F20',o:638.00,h:678.00,l:636.00,c:667.77},{date:'F23',o:664.05,h:688.07,l:652.21,c:674.73},{date:'F24',o:680.01,h:698.50,l:662.00,c:688.27}]},
  BE:  {wk52Low:30, ath:176.49, normalPullback:'25â€“45%', breakLevel:'~$110', runPct:'+487%',
    candles:[{date:'F18',o:146.65,h:158.40,l:145.50,c:157.27},{date:'F19',o:154.13,h:160.08,l:150.70,c:159.00},{date:'F20',o:155.83,h:159.11,l:144.06,c:147.55},{date:'F23',o:147.70,h:161.25,l:145.84,c:160.28},{date:'F24',o:157.40,h:173.07,l:154.69,c:166.20}]},
  SNDK:{wk52Low:27, ath:695.00, normalPullback:'28â€“52%', breakLevel:'~$450', runPct:'+2,474%',
    candles:[{date:'F19',o:597.33,h:634.48,l:590.10,c:621.09},{date:'F20',o:616.00,h:650.29,l:615.65,c:649.97},{date:'F23',o:659.59,h:691.54,l:644.38,c:666.49},{date:'F24',o:682.50,h:684.09,l:612.92,c:638.52},{date:'F25',o:644.29,h:661.20,l:629.00,c:639.25}]},
};

let liveData = {};
let fundsData = {};
let watchlist = JSON.parse(localStorage.getItem('rhythmWatchlist') || 'null') || [...DEFAULT_TICKERS];
let weeklyRows = [];
let ntfyChannel = localStorage.getItem('ntfyCh') || '';
let autoRefreshTimer = null;

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  buildStrip();
  buildCards();
  buildSuggestions();
  if (ntfyChannel) document.getElementById('ntfyCh').value = ntfyChannel;
  seedWeekly();
  buildWeekly();
  document.getElementById('autoRefCb') && document.getElementById('autoRefCb').addEventListener('change', toggleAutoRef);
});

// ============================================================
// DATA FETCHERS
// ============================================================

// Twelve Data â€” real prices, CORS-friendly, 800 free calls/day
async function fetchTD(sym) {
  try {
    const r = await pFetch(`${TD_BASE}/quote?symbol=${sym}&apikey=${TD_KEY}`);
    if (!r) { console.warn('[TD] no response:', sym); return null; }
    const d = await r.json();
    console.log('[TD]', sym, JSON.stringify(d).slice(0,200));
    if (d.status === 'error' || !d.close) { console.warn('[TD] bad data:', sym, d.message||'no close'); return null; }
    const price = parseFloat(d.close);
    const prev  = parseFloat(d.previous_close) || price;
    const open  = parseFloat(d.open)  || price;
    const high  = parseFloat(d.high)  || price;
    const low   = parseFloat(d.low)   || price;
    return { price, prev, open, high, low, chg:price-prev, pct:prev?(price-prev)/prev*100:0, name:(d.name||sym).toUpperCase(), ok:true };
  } catch(e) { console.error('[TD]', sym, e.message); return null; }
}

// FMP â€” fundamentals only
async function fetchFMP(sym) {
  try {
    const [profileR, metricsR, earningsR] = await Promise.allSettled([
      pFetch(`${FMP}/profile/${sym}?apikey=${FMP_KEY}`, 10000),
      pFetch(`${FMP}/key-metrics/${sym}?limit=4&apikey=${FMP_KEY}`, 10000),
      pFetch(`${FMP}/historical/earning_calendar/${sym}?apikey=${FMP_KEY}`, 10000),
    ]);

    let profile = {}, metrics = [], earnings = [];

    if (profileR.status === 'fulfilled' && profileR.value?.ok) {
      const d = await profileR.value.json();
      profile = Array.isArray(d) ? (d[0] || {}) : (d || {});
    }
    if (metricsR.status === 'fulfilled' && metricsR.value?.ok) {
      const d = await metricsR.value.json();
      metrics = Array.isArray(d) ? d : [];
    }
    if (earningsR.status === 'fulfilled' && earningsR.value?.ok) {
      const d = await earningsR.value.json();
      earnings = Array.isArray(d) ? d : [];
    }

    const fwdPE = profile?.pe || null;
    const peg = metrics[0]?.pegRatio || null;
    const revGrowth = metrics[0]?.revenueGrowth || null;
    const analystTarget = profile?.targetHigh ? ((profile.targetHigh + (profile.targetLow||profile.targetHigh)) / 2) : null;

    const past = earnings.filter(e => e.eps !== null && e.epsEstimated !== null).slice(0, 3);
    const epsTrend = past.map(e => e.eps >= e.epsEstimated);

    const today = new Date();
    const upcoming = earnings.find(e => new Date(e.date) > today);
    const earningsDate = upcoming ? upcoming.date : null;
    const earningsDays = earningsDate ? Math.ceil((new Date(earningsDate) - today) / 86400000) : null;

    const profilePrice = profile?.price || profile?.lastPrice || null;
    const companyName = profile?.companyName || null;
    return { fwdPE, peg, revGrowth, analystTarget, epsTrend, earningsDate, earningsDays, profilePrice, companyName, ok: true };
  } catch(e) {
    return { ok: false };
  }
}

// ============================================================
// REFRESH ALL
// ============================================================
async function refreshAll() {
  const btn = document.getElementById('rfrBtn');
  btn.classList.add('spin');
  btn.textContent = 'â†» LOADING';
  document.getElementById('statusBar').textContent = 'FETCHING LIVE DATA...';

  let priceOk = 0, fundsOk = 0;

  // Prices: Twelve Data (CORS ok, free). Fundamentals: FMP. Run in parallel.
  await Promise.allSettled([
    ...watchlist.map(async sym => {
      const d = await fetchTD(sym);
      if (d?.ok) { liveData[sym] = d; priceOk++; }
      else console.warn('[RHYTHM] no price for', sym);
    }),
    ...watchlist.map(async sym => {
      const d = await fetchFMP(sym);
      if (d?.ok) { fundsData[sym] = d; fundsOk++; }
    })
  ]);

  btn.classList.remove('spin');
  btn.textContent = 'â†» REFRESH';

  const now = new Date();
  const t = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('statusBar').textContent = `LAST UPDATE: ${t} Â· PRICES: ${priceOk}/${watchlist.length} Â· FUNDAMENTALS: ${fundsOk}/${watchlist.length}`;
  document.getElementById('fundsDate').textContent = `UPDATED ${t} Â· FMP/SEC FILINGS Â· ${fundsOk}/${watchlist.length} LOADED`;

  buildStrip();
  buildCards();
  buildFundamentals();
  checkAlerts();
}

// ============================================================
// TICKER STRIP
// ============================================================
function buildStrip() {
  const s = document.getElementById('strip');
  s.innerHTML = '';
  watchlist.forEach(sym => {
    const d = liveData[sym];
    const color = TC[SECTOR_MAP[sym]||'default'];
    const pct = d ? d.pct : 0;
    const pc = pct > 0 ? 'up' : pct < 0 ? 'dn' : 'fl';
    const ps = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
    const el = document.createElement('div');
    el.className = 'strip-item';
    el.innerHTML = `<div class="s-sym" style="color:${color}">${sym}</div><div class="s-pct ${pc}">${ps}</div>`;
    el.onclick = () => { switchTab('channels', document.querySelector('.tab')); setTimeout(() => document.getElementById('c-'+sym)?.scrollIntoView({behavior:'smooth',block:'start'}), 100); };
    s.appendChild(el);
  });
  const plus = document.createElement('div');
  plus.className = 'strip-add';
  plus.innerHTML = 'ï¼‹';
  plus.onclick = openModal;
  s.appendChild(plus);
}

// ============================================================
// BUILD CHANNEL CARDS
// ============================================================
function getColor(sym) { return TC[SECTOR_MAP[sym]||'default']; }
function getSector(sym) { return SECTOR_MAP[sym]||'default'; }

function getChannelPos(sym, price) {
  const s = SEED[sym];
  if (!s) return 50;
  return Math.min(Math.max(((price - s.wk52Low) / (s.ath - s.wk52Low)) * 100, 0), 99);
}

function getZone(pos) {
  if (pos >= 85) return {label:'EXTENDED / ATH', cls:'se', badge:'EXTENDED'};
  if (pos >= 65) return {label:'HIGH ZONE',       cls:'sc2',badge:'HIGH'};
  if (pos >= 40) return {label:'MID ZONE',         cls:'sn', badge:'NORMAL'};
  if (pos >= 20) return {label:'LOW ZONE',          cls:'sc2',badge:'WATCH'};
  return               {label:'DANGER ZONE',       cls:'sw', badge:'DANGER'};
}

function buildCards() {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = '';
  if (!watchlist.length) {
    grid.innerHTML = `<div class="loading-card" style="text-align:center;padding:40px"><div class="loading-text">NO TICKERS Â· TAP + TO ADD</div><button onclick="openModal()" style="margin-top:16px;font-family:var(--display);font-weight:700;font-size:14px;letter-spacing:3px;color:var(--green);background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.25);padding:10px 20px;border-radius:4px;cursor:pointer">+ ADD TICKER</button></div>`;
    return;
  }

  watchlist.forEach(sym => {
    const d = liveData[sym] || {price:0,open:0,high:0,low:0,pct:0,chg:0,name:sym};
    const seed = SEED[sym] || {wk52Low:d.price*.5,ath:d.price*1.5,normalPullback:'N/A',breakLevel:'N/A',runPct:'N/A',candles:[]};
    const color = getColor(sym);
    const sector = getSector(sym);
    const pos = getChannelPos(sym, d.price);
    const zone = getZone(pos);
    const chgUp = d.pct >= 0;
    const cs = chgUp?'up':'dn';
    const sg = chgUp?'+':'';

    const cans = seed.candles || [];
    let candleHtml = '';
    if (cans.length) {
      const allP = cans.flatMap(c=>[c.l,c.h]);
      const mn = Math.min(...allP), mx = Math.max(...allP), rng = mx-mn||1;
      const pp = v => 100 - ((v-mn)/rng*78+11);
      candleHtml = cans.map(c => {
        const g = c.c >= c.o;
        const bT = Math.min(pp(c.o),pp(c.c)), bB = Math.max(pp(c.o),pp(c.c));
        const dp = ((c.c-c.o)/c.o*100);
        const dps = (dp>=0?'+':'')+dp.toFixed(1)+'%';
        return `<div class="c-day">
          <div class="c-wick" style="top:${pp(c.h)}%;height:${pp(c.l)-pp(c.h)}%"></div>
          <div class="c-body" style="top:${bT}%;height:${Math.max(bB-bT,2)}%;background:${g?'var(--green)':'var(--red)'};opacity:0.82"></div>
          <div class="c-date">${c.date}</div>
          <div class="c-pct" style="color:${dp>=0?'var(--green)':'var(--red)'}">${dps}</div>
        </div>`;
      }).join('');
    }

    const cc = pos>85?'var(--purple)':pos>65?'var(--green)':pos>40?'var(--blue)':'var(--red)';
    const fmt = (n,d=2) => n.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

    const card = document.createElement('div');
    card.className = 'scard';
    card.id = 'c-'+sym;
    card.innerHTML = `
      <button class="rm-btn" onclick="removeTicker('${sym}')">âœ•</button>
      <div class="scard-hdr">
        <div>
          <div class="tk ${sector}">${sym}</div>
          <div class="co">${(d.name||sym).slice(0,22)}</div>
        </div>
        <div class="price-col">
          <div class="cp">$${fmt(d.price)}</div>
          <div class="dc ${cs}">${sg}${d.pct.toFixed(2)}%&nbsp; ${sg}$${fmt(Math.abs(d.chg))}</div>
        </div>
      </div>
      <div class="ohlc">
        <div class="oc"><div class="ol">OPEN</div><div class="ov">$${fmt(d.open)}</div></div>
        <div class="oc"><div class="ol">HIGH</div><div class="ov" style="color:var(--green)">$${fmt(d.high)}</div></div>
        <div class="oc"><div class="ol">LOW</div><div class="ov" style="color:var(--red)">$${fmt(d.low)}</div></div>
        <div class="oc"><div class="ol">ATH</div><div class="ov" style="color:var(--yellow)">$${seed.ath.toLocaleString()}</div></div>
      </div>
      <div class="ch-sec">
        <div class="ch-lbl">52-WK CHANNEL Â· $${seed.wk52Low} LOW â”€â”€â”€ ATH $${seed.ath.toLocaleString()}</div>
        <div class="ch-bar">
          <div class="cz z-d" style="left:0%;width:10%"></div>
          <div class="cz z-l" style="left:10%;width:18%"></div>
          <div class="cz z-m" style="left:28%;width:25%"></div>
          <div class="cz z-h" style="left:53%;width:25%"></div>
          <div class="cz z-e" style="left:78%;width:22%"></div>
          <div class="zdv" style="left:10%"></div><div class="zdv" style="left:28%"></div>
          <div class="zdv" style="left:53%"></div><div class="zdv" style="left:78%"></div>
          <div class="rng-lo">$${seed.wk52Low}</div>
          <div class="rng-hi">$${seed.ath.toLocaleString()}</div>
          <div class="cur" style="left:${pos}%;background:${cc};box-shadow:0 0 10px ${cc}">
            <div class="cur-lbl" style="color:${cc}">â–² ${zone.label}</div>
          </div>
        </div>
        <div class="ch-marks">
          <span style="color:#aa2040">DANGER</span><span>LOW</span>
          <span>MID</span><span>HIGH</span>
          <span style="color:var(--purple)">EXTENDED</span>
        </div>
      </div>
      ${cans.length ? `
      <div class="candle-wrap">
        <div class="candle-lbl">RECENT SESSIONS â€” DAILY % OPENâ†’CLOSE</div>
        <div class="candle-row">${candleHtml}</div>
      </div>` : ''}
      <div class="stats-row">
        <div class="sc"><div class="sl">TOTAL RUN</div><div class="sv up">${seed.runPct}</div></div>
        <div class="sc"><div class="sl">NORMAL PULLBACK</div><div class="sv dn">${seed.normalPullback}</div></div>
        <div class="sc"><div class="sl">BREAK LEVEL</div><div class="sv" style="color:var(--yellow);font-size:13px">${seed.breakLevel}</div></div>
      </div>
      <div class="sig-row">
        <div class="sig-b ${zone.cls}">${zone.badge}</div>
        <div class="sig-note">${getSignalNote(sym, pos, d.pct)}</div>
      </div>`;
    grid.appendChild(card);
  });
}

function getSignalNote(sym, pos, pct) {
  let note = pos>=85?'Extended. Consider trimming 20â€“25%.':pos>=65?'High zone. Hold. Monitor weekly.':pos>=40?'Mid zone. Normal uptrend. No action.':pos>=20?'Low zone. Add opportunity if thesis intact.':'Danger zone. Check volume + fundamentals.';
  if (Math.abs(pct)>=5) note = `${pct>=0?'â–² BIG UP':'â–¼ BIG DOWN'} (${Math.abs(pct).toFixed(1)}%). `+note;
  return note;
}

// ============================================================
// FUNDAMENTALS TABLE
// ============================================================
function calcValueScore(f, pos) {
  if (!f) return null;
  let score = 5;
  if (f.peg !== null) {
    if (f.peg < 1.0)      score += 2;
    else if (f.peg < 1.5) score += 1;
    else if (f.peg > 3.0) score -= 2;
    else if (f.peg > 2.0) score -= 1;
  }
  if (f.revGrowth !== null) {
    if (f.revGrowth > 0.4)       score += 2;
    else if (f.revGrowth > 0.2)  score += 1;
    else if (f.revGrowth < 0.05) score -= 1;
    else if (f.revGrowth < 0)    score -= 2;
  }
  if (f.epsTrend && f.epsTrend.length) {
    const beats = f.epsTrend.filter(Boolean).length;
    if (beats === 3)      score += 1;
    else if (beats === 0) score -= 1;
  }
  if (pos >= 85) score -= 1;
  if (pos >= 95) score -= 1;
  if (f.analystTarget && liveData[f._sym]) {
    const upside = ((f.analystTarget - liveData[f._sym].price) / liveData[f._sym].price) * 100;
    if (upside > 15)       score += 1;
    else if (upside < -10) score -= 1;
  }
  return Math.min(Math.max(Math.round(score), 1), 10);
}

function buildFundamentals() {
  const tbody = document.getElementById('fundsBody');
  tbody.innerHTML = '';
  if (!watchlist.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:28px;font-family:var(--mono);font-size:10px;color:var(--text-dim);">NO TICKERS IN WATCHLIST</td></tr>';
    return;
  }
  watchlist.forEach(sym => {
    const d = liveData[sym];
    const f = fundsData[sym];
    const color = getColor(sym);
    const pos = d ? getChannelPos(sym, d.price) : 50;
    const price = d ? `$${d.price.toFixed(2)}` : 'â€”';
    const fwdPE = f?.fwdPE ? f.fwdPE.toFixed(1)+'x' : 'â€”';
    let pegHtml = 'â€”';
    if (f?.peg) {
      const pc = f.peg < 1.5 ? 'var(--green)' : f.peg < 2.5 ? 'var(--yellow)' : 'var(--red)';
      pegHtml = `<span style="color:${pc};font-weight:700">${f.peg.toFixed(2)}</span>`;
    }
    let revHtml = 'â€”';
    if (f?.revGrowth !== null && f?.revGrowth !== undefined) {
      const rg = (f.revGrowth * 100).toFixed(1);
      const rc = f.revGrowth > 0.2 ? 'var(--green)' : f.revGrowth > 0 ? 'var(--yellow)' : 'var(--red)';
      revHtml = `<span style="color:${rc};font-weight:700">${rg > 0 ? '+' : ''}${rg}%</span>`;
    }
    let epsHtml = 'â€”';
    if (f?.epsTrend && f.epsTrend.length) {
      epsHtml = f.epsTrend.map(b => b ? '<span class="beat">ðŸŸ¢</span>' : '<span class="miss">ðŸ”´</span>').join(' ');
    }
    let targetHtml = 'â€”', upsideHtml = 'â€”';
    if (f?.analystTarget && d) {
      targetHtml = `$${f.analystTarget.toFixed(0)}`;
      const upside = ((f.analystTarget - d.price) / d.price) * 100;
      const uc = upside > 5 ? 'upside-pos' : upside < -5 ? 'upside-neg' : 'fl';
      upsideHtml = `<span class="${uc}">${upside >= 0 ? '+' : ''}${upside.toFixed(1)}%</span>`;
    }
    let earnHtml = 'â€”';
    if (f?.earningsDays !== null && f?.earningsDays !== undefined) {
      const ec = f.earningsDays <= 7 ? 'earn-soon' : f.earningsDays <= 21 ? 'earn-near' : 'earn-ok';
      earnHtml = `<span class="${ec}">${f.earningsDays}d</span>`;
      if (f.earningsDate) earnHtml += `<br><span style="font-size:8px;color:var(--text-dim)">${f.earningsDate}</span>`;
    }
    if (f) f._sym = sym;
    const vs = calcValueScore(f, pos);
    let vsHtml = 'â€”';
    if (vs !== null) {
      const vc = vs >= 7 ? 'vs-hi' : vs >= 5 ? 'vs-md' : 'vs-lo';
      vsHtml = `<span class="vscore ${vc}">${vs}/10</span>`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="f-sym" style="color:${color}">${sym}</span></td>
      <td>${price}</td>
      <td>${fwdPE}</td>
      <td>${pegHtml}</td>
      <td>${revHtml}</td>
      <td>${epsHtml}</td>
      <td style="color:var(--text-dim)">${targetHtml}</td>
      <td>${upsideHtml}</td>
      <td>${earnHtml}</td>
      <td>${vsHtml}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ============================================================
// ADD / REMOVE TICKERS
// ============================================================
function openModal() { document.getElementById('modalOv').classList.add('open'); document.getElementById('tInput').value=''; document.getElementById('mStatus').textContent=''; setTimeout(()=>document.getElementById('tInput').focus(),100); }
function closeModal() { document.getElementById('modalOv').classList.remove('open'); }
function closeBg(e) { if(e.target===document.getElementById('modalOv')) closeModal(); }

async function addTicker() {
  const sym = document.getElementById('tInput').value.trim().toUpperCase().replace(/[^A-Z]/g,'');
  const status = document.getElementById('mStatus');
  if (!sym) return;
  if (watchlist.includes(sym)) { status.style.color='var(--yellow)'; status.textContent=sym+' ALREADY IN WATCHLIST'; return; }
  status.style.color='var(--text-dim)'; status.textContent='FETCHING '+sym+'...';
  const [price, funds] = await Promise.all([fetchTD(sym), fetchFMP(sym)]);
  if (!price?.ok) { status.style.color='var(--red)'; status.textContent='NOT FOUND: '+sym+' â€” CHECK SYMBOL'; return; }
  liveData[sym] = price;
  if (funds?.ok) fundsData[sym] = funds;
  watchlist.push(sym);
  localStorage.setItem('rhythmWatchlist', JSON.stringify(watchlist));
  status.style.color='var(--green)'; status.textContent='âœ“ '+sym+' ADDED Â· $'+price.price.toFixed(2);
  buildStrip(); buildCards(); buildFundamentals();
  setTimeout(closeModal, 900);
}

function removeTicker(sym) {
  if (!confirm('Remove '+sym+' from watchlist?')) return;
  watchlist = watchlist.filter(t=>t!==sym);
  localStorage.setItem('rhythmWatchlist', JSON.stringify(watchlist));
  buildStrip(); buildCards(); buildFundamentals();
}

function buildSuggestions() {
  const c = document.getElementById('sugChips');
  SUGGESTIONS.forEach(s => {
    const ch = document.createElement('div');
    ch.className = 'chip';
    ch.textContent = s;
    ch.onclick = () => { document.getElementById('tInput').value=s; addTicker(); };
    c.appendChild(ch);
  });
}

// ============================================================
// WEEKLY LOG
// ============================================================
const SEED_WEEKLY = [
  {week:'FEB 18',ticker:'VRT', price:'243.21',move:'-0.13',zone:'HIGH',   status:'cs-n',notes:'Tight action. Holding channel.'},
  {week:'FEB 18',ticker:'MU',  price:'420.95',move:'+5.30',zone:'HIGH',   status:'cs-n',notes:'Strong bounce off $394 low.'},
  {week:'FEB 18',ticker:'LITE',price:'594.26',move:'-1.03',zone:'HIGH',   status:'cs-c',notes:'Building base.'},
  {week:'FEB 18',ticker:'BE',  price:'157.27',move:'+8.22',zone:'EXTENDED',status:'cs-e',notes:'Momentum. Watch ATH approach.'},
  {week:'FEB 18',ticker:'SNDK',price:'621.09',move:'+3.98',zone:'HIGH',   status:'cs-n',notes:'Steady climb.'},
  {week:'FEB 25',ticker:'VRT', price:'253.15',move:'+5.95',zone:'AT ATH', status:'cs-e',notes:'Pre-mkt $258. Trim zone.'},
  {week:'FEB 25',ticker:'MU',  price:'428.78',move:'+2.58',zone:'HIGH/CONSOL',status:'cs-c',notes:'Best entry setup in basket.'},
  {week:'FEB 25',ticker:'LITE',price:'748.00',move:'+8.68',zone:'PARABOLIC',status:'cs-e',notes:'1600% run. Trail stops.'},
  {week:'FEB 25',ticker:'BE',  price:'174.65',move:'+5.08',zone:'NEAR ATH',status:'cs-e',notes:'Near $176.49 ATH.'},
  {week:'FEB 25',ticker:'SNDK',price:'639.25',move:'+0.11',zone:'HIGH/OFF ATH',status:'cs-c',notes:'Feb 24 shooting star.'},
];

function seedWeekly() { if (!weeklyRows.length) weeklyRows = [...SEED_WEEKLY]; }

function buildWeekly() {
  const tb = document.getElementById('weeklyBody');
  tb.innerHTML = '';
  weeklyRows.forEach(r => {
    const m = parseFloat(r.move);
    const mc = m>0?'up':m<0?'dn':'fl';
    const bw = Math.min(Math.abs(m)*6,50);
    const bc = m>0?'var(--green)':'var(--red)';
    const color = getColor(r.ticker);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="wt-tk" style="color:${color}">${r.ticker}</span></td>
      <td style="color:var(--text-dim)">${r.week}</td>
      <td><input class="pi" value="${r.price}" placeholder="0.00"></td>
      <td class="${mc}"><span class="mbar" style="width:${bw}px;background:${bc}"></span>${r.move}%</td>
      <td style="font-size:9px">${r.zone}</td>
      <td><span class="cst ${r.status}">${r.status.replace('cs-','').toUpperCase()}</span></td>
      <td><input class="ni" value="${r.notes}" placeholder="note..."></td>`;
    tb.appendChild(tr);
  });
}

function addWeekRow() {
  const wk = new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}).toUpperCase();
  watchlist.forEach(sym => {
    const d = liveData[sym];
    const pos = d ? getChannelPos(sym,d.price) : 50;
    weeklyRows.push({week:wk,ticker:sym,price:d?d.price.toFixed(2):'',move:d?(d.pct>=0?'+':'')+d.pct.toFixed(2):'0.0',zone:getZone(pos).label,status:'cs-n',notes:''});
  });
  buildWeekly();
}

// ============================================================
// ALERTS (ntfy)
// ============================================================
function saveNtfy() {
  ntfyChannel = document.getElementById('ntfyCh').value.trim();
  localStorage.setItem('ntfyCh', ntfyChannel);
  document.getElementById('ntfyStatus').textContent = ntfyChannel ? 'âœ“ SAVED: '+ntfyChannel : 'CLEARED';
}

async function sendAlert(title, msg, priority='default') {
  if (!ntfyChannel) return;
  try { await fetch(`https://ntfy.sh/${ntfyChannel}`,{method:'POST',headers:{'Title':title,'Priority':priority,'Tags':'chart_increasing'},body:msg}); } catch{}
}

async function testAlert() {
  if (!ntfyChannel) { alert('Set your ntfy channel name first!'); return; }
  await sendAlert('RHYTHM TEST âœ“', 'Your RHYTHM alerts are working! Channel: '+ntfyChannel, 'high');
  document.getElementById('ntfyStatus').textContent = 'âœ“ TEST SENT TO: '+ntfyChannel;
}

function checkAlerts() {
  const pctThresh   = parseFloat(document.getElementById('alertPct')?.value||5);
  const dangerThresh= parseFloat(document.getElementById('alertDanger')?.value||15);
  const extThresh   = parseFloat(document.getElementById('alertExtended')?.value||85);
  const earnThresh  = parseFloat(document.getElementById('alertEarnings')?.value||7);

  watchlist.forEach(sym => {
    const d = liveData[sym]; if (!d) return;
    const f = fundsData[sym];
    const pos = getChannelPos(sym, d.price);
    const abs = Math.abs(d.pct);
    if (abs >= pctThresh) sendAlert(`RHYTHM: ${sym} ${d.pct>=0?'â–²':'â–¼'} ${d.pct.toFixed(1)}%`, `${sym} moved ${d.pct.toFixed(1)}% today to $${d.price.toFixed(2)}. Channel: ${getZone(pos).label}`, 'high');
    if (pos <= dangerThresh) sendAlert(`âš  ${sym} DANGER ZONE`, `${sym} at $${d.price.toFixed(2)} entered DANGER ZONE. Potential add opportunity if thesis intact.`);
    if (pos >= extThresh) sendAlert(`ðŸ“ˆ ${sym} EXTENDED`, `${sym} at $${d.price.toFixed(2)} is EXTENDED (top ${(100-pos).toFixed(0)}% of range). Consider trimming.`);
    if (f?.earningsDays && f.earningsDays <= earnThresh) sendAlert(`ðŸ“… ${sym} EARNINGS IN ${f.earningsDays} DAYS`, `${sym} reports on ${f.earningsDate}. Consider position sizing before announcement.`, 'high');
  });
}

// ============================================================
// TABS + AUTO REFRESH
// ============================================================
function switchTab(name, el) {
  document.querySelectorAll('.tc').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if (el) el.classList.add('active');
}

function toggleAutoRef() {
  const on = document.getElementById('autoRefCb')?.checked;
  clearInterval(autoRefreshTimer);
  if (on) autoRefreshTimer = setInterval(refreshAll, 5*60*1000);
}
</script>
</body>
</html>
